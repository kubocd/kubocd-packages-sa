

apiVersion: v1alpha1
name: podinfo
tag: 6.7.1-p01
schema:
  parameters:
    properties:
      host: { type: string, required: false }
      tls: { type: boolean, default: false }
  context:
    properties:
      ingress:
        required: true
        properties:
          className: { type: string, default: "nginx"}
          hostPostfix: { type: string, required: true }
templateHeader: |
  {{- $uiHost := .Parameters.host | default (printf "%s-%s" .Release.metadata.name .Release.metadata.namespace) -}}
description: |
  A sample application on {{ $uiHost }}
usage:
  text: |
    Podinfo can be accessed using {{if .Parameters.tls}}https{{else}}http{{end}}://{{ $uiHost }}.{{ .Context.ingress.hostPostfix }}
  html: |
    Podinfo can be accessed using <a href="{{if .Parameters.tls}}https{{else}}http{{end}}://{{ $uiHost }}.{{ .Context.ingress.hostPostfix }}">this link</a>
modules:
  - name: main
    specPatch:
      timeout: 2m
    source:
      helmRepository:
        url: https://stefanprodan.github.io/podinfo
        chart: podinfo
        version: 6.7.1
    values: |
      ingress:
        enabled: true
        className: {{ .Context.ingress.className  }}
        {{- if .Parameters.tls }}
        annotations:
          cert-manager.io/cluster-issuer: {{ required ".Context.certificateIssuer.public must be defined if tls: true" .Context.certificateIssuer.public }}
        {{- end }}
        hosts:
          - host: {{ $uiHost }}.{{ .Context.ingress.hostPostfix }}
            paths:
              - path: /
                pathType: ImplementationSpecific
        {{- if .Parameters.tls }}
        tls:
          - secretName: {{ .Release.metadata.name }}-tls
            hosts:
              - {{ $uiHost }}.{{ .Context.ingress.hostPostfix }}
        {{- end }}
      {{- $redirection := imageRedirect "ghcr.io/stefanprodan/podinfo:6.7.1" . }}
      image: 
        repository: {{ $redirection.repository }}
        pullPolicy: {{ $redirection.imagePullPolicy | default "IfNotPresent" }}
        tag: {{ $redirection.tag }}
dependencies: |
  - ingress
  {{ if .Parameters.tls }}
  - certManager
  {{ end }}