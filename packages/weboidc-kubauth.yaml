

apiVersion: v1alpha1
name: weboidc-kubauth
tag: 0.1.0-p01
schema:
  parameters:
    properties:
      name: { type: string, default: WEBOIDC }
      logger:
        properties:
          mode: { type: string, default: dev, enum: [ "dev", "json"] }
          level: { type: string, default: info, enum: [ "error", "info", "debug", "trace"] }
      host: { type: string, required: true }
      tls: { type: boolean, default: false }
      oidc:
        required: true
        properties:
          clientSecret: { type: string, required: true }
          clientSecretHash: { type: string, required: true }
  context:
    properties:
      ingress:
        required: true
        properties:
          className: { type: string, default: "nginx"}
          domain: { type: string, required: true }
      oidc:
        required: true
        properties:
          issuerURL: { type: string, required: true }
      certificateIssuer:
        required: true
        properties:
          public: { type: string, required: true }
      networkPolicies: { type: boolean, required: true }
modules:

  - name: noname
    source:
      oci:
        repository: quay.io/kuboauth/charts/weboidc
        tag: 0.1.0-snapshot
    values: |
      name: {{ .Parameters.name }}
      log:
        mode: {{ .Parameters.logger.mode }}
        level: {{ .Parameters.logger.level  }}
      ingress:
        enabled: true
        class: {{ .Context.ingress.className }}
        host: {{ .Parameters.host}}.{{.Context.ingress.domain}}
        networkPolicy:
          enabled: {{ .Context.networkPolicies}}
      server:
        certificateIssuer: {{ .Context.certificateIssuer.public }}
      oidc:
        clientId:
          value: {{ .Release.metadata.namespace}}-{{.Release.metadata.name }}
        clientSecret:
          value: {{ .Parameters.oidc.clientSecret }}
        issuerUrl: {{ .Context.oidc.issuerURL}}
        scopes: [ "openid", "offline", "profile", "groups", "email"]
        ca:
          secret:
            name: certs-bundle
            key: ca.crt

  - name: client
    source:
      local:
        path: ../charts/wrapper/1.0.0
    values:
      body: |
        apiVersion: kubauth.kubotal.io/v1alpha1
        kind: OidcClient
        metadata:
          name: {{ .Release.metadata.namespace}}-{{.Release.metadata.name}}
          namespace: kubauth-oidc
        spec:
          accessTokenLifespan: 1h0m0s
          description: A first test OIDC client application
          displayName: Weboidc (1)
          entryURL: https:{{ .Parameters.host}}.{{.Context.ingress.domain}}
          grantTypes: [ "refresh_token", "authorization_code" ]
          hashedSecret: {{ .Parameters.oidc.clientSecretHash }}
          idTokenLifespan: 1h0m0s
          public: false
          redirectURIs:
            - https://{{ .Parameters.host}}.{{.Context.ingress.domain}}/wo_callback
          refreshTokenLifespan: 1h0m0s
          responseTypes: ["id_token", "code", "token", "id_token token", "code id_token", "code token", "code id_token token"]
          scopes: [ "openid", "offline", "profile", "groups", "email"]

dependencies: |
  - ingress
  - oidc-server
  {{ if .Parameters.tls }}
  - certManager
  {{ end }}