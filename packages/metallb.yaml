
apiVersion: v1alpha1
name: metallb
tag: 0.14.9-p02
protected: true
schema:
  parameters:
    properties:
      deployInControlPlane: { type: boolean, default: false }
      deployInServicePlane: { type: boolean, default: false }
      speakerTolerations:
        items:
          properties:
            key: { type: string, required: true }
            operator: { type: string, required: true }
            effect: { type: string, required: false }
            value: { type: string, required: false }
            tolerationSeconds: { type: integer, required: false }
  context:
    properties:
      # One of cluster.domain or metallb.pool must be defined. If both, metallb pool take precedence
      cluster:
        required: false
        properties:
          domain: { type: string, required: true }
      loadBalancer:
        required: false
        properties:
          pool:
            required: true
            properties:
              first: { type: string, required: true }
              last: { type: string, required: true }
modules:
  - name: noname
    timeout: 4m
    source:
      helmRepository:
        url: https://metallb.github.io/metallb
        chart: metallb
        version: 0.14.9
    values: |
      controller:
        {{- if .Parameters.deployInControlPlane }}
        tolerations:
          - key: "node-role.kubernetes.io/control-plane"
            operator: "Exists"
            effect: "NoSchedule"
        nodeSelector:
          node-role.kubernetes.io/control-plane: ""
        {{- end }}      
        {{- if .Parameters.deployInServicePlane }}
        tolerations:
          - key: services.node-role.kubernetes.io
            operator: "Equal"
            effect: NoSchedule
            value: services
        nodeSelector:
          services.node-role.kubernetes.io: "services"
        {{- end }}
        image:
          {{ $redirection := imageRedirect "quay.io/metallb/controller" . }}
          repository: {{ $redirection.repository }}
      speaker:
        {{- with .Parameters.speakerTolerations }}
        tolerations:
        {{- range . }}
          - key: {{ .key }}
            operator: {{ .operator }}
            {{ with .effect }}effect: {{.}}{{end}}
            {{ with .value }}value: {{.}}{{end}}
            {{ with .tolerationSeconds }}tolerationSeconds: {{.}}{{end}}
        {{- end }}
        {{- end }}
        image:
          {{ $redirection := imageRedirect "quay.io/metallb/speaker" . }}
          repository: {{ $redirection.repository }}
        frr:
          image:
            {{ $redirection := imageRedirect "quay.io/frrouting/frr" . }}
            repository: {{ $redirection.repository }}
  - name: pool
    source:
      local:
        path: ../charts/metallb-pool/0.1.0
    values: |
      {{- if .Context.loadBalancer }}
      ipRanges:
        - first: {{ resolveDNS (.Context.loadBalancer.pool.first) }}
          last:  {{ resolveDNS (.Context.loadBalancer.pool.last) }}
      {{- else if .Context.cluster }}
      ipRanges:
        - first: {{ resolveDNS ( printf "first.pool.%s" .Context.cluster.domain ) }}
          last:  {{ resolveDNS ( printf "last.pool.%s" .Context.cluster.domain ) }}
      {{- else }}
        {{ fail "At least one of .Context.metallb.pool or .Context.cluster.domain must be defined" }} 
      {{- end }}
    dependsOn:
      - noname
roles:
  - loadBalancer
