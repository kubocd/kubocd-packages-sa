
apiVersion: v1alpha1
name: metallb
tag: 0.14.9-p01
protected: true
schema:
  context:
    properties:
      # One of cluster.domain or metallb.pool must be defined. If both, metallb pool take precedence
      cluster:
        required: false
        properties:
          domain: { type: string, required: true }
      loadBalancer:
        required: false
        properties:
          pool:
            required: true
            properties:
              first: { type: string, required: true }
              last: { type: string, required: true }
modules:
  - name: main
    timeout: 4m
    source:
      helmRepository:
        url: https://metallb.github.io/metallb
        chart: metallb
        version: 0.14.9
    values: |
      controller:
        image:
          {{ $redirection := imageRedirect "quay.io/metallb/controller" . }}
          repository: {{ $redirection.repository }}
      speaker:
        image:
          {{ $redirection := imageRedirect "quay.io/metallb/speaker" . }}
          repository: {{ $redirection.repository }}
        frr:
          image:
            {{ $redirection := imageRedirect "quay.io/frrouting/frr" . }}
            repository: {{ $redirection.repository }}
  - name: pool
    source:
      local:
        path: ../charts/metallb-pool/0.1.0
    values: |
      {{- if .Context.loadBalancer }}
      ipRanges:
        - first: {{ resolveDNS (.Context.loadBalancer.pool.first) }}
          last:  {{ resolveDNS (.Context.loadBalancer.pool.last) }}
      {{- else if .Context.cluster }}
      ipRanges:
        - first: {{ resolveDNS ( printf "first.pool.%s" .Context.cluster.domain ) }}
          last:  {{ resolveDNS ( printf "last.pool.%s" .Context.cluster.domain ) }}
      {{- else }}
        {{ fail "At least one of .Context.metallb.pool or .Context.cluster.domain must be defined" }} 
      {{- end }}
    dependsOn:
      - main
roles:
  - loadBalancer
