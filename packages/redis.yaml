

apiVersion: v1alpha1
name: redis
tag: 20.6.1-p01
description: Redis and a front UI
templateHeader: | 
  {{- $uiHost :=  .Parameters.commander.host | default (printf "%s-%s-ui" .Release.metadata.name .Release.metadata.namespace) -}}
usage:
  text: |
    Redis UI can be accessed using {{if .Parameters.commander.tls}}https{{else}}http{{end}}://{{ $uiHost }}.{{.Context.ingress.hostPostfix}}
schema:
  parameters:
    description: Redis stack
    properties:
      redis:
        required: false
        properties:
          password: { type: string, default: redis123 }
          replicaCount: { type: integer, default: 1, description: "The number of replicas"}
      commander:
        required: true
        properties:
          enabled: { type: boolean, default: true }
          tls: { type: boolean, default: false }
          host: { type: string, required: false }
  context:
    properties:
      ingress:
        required: true
        properties:
          className: { type: string, default: "nginx"}
          clusterIssuer: { type: string }
          hostPostfix: { type: string, required: true }
modules:
  - name: redis
    specPatch:
      timeout: 2m
    source:
      oci:
        repository: registry-1.docker.io/bitnamicharts/redis
        tag: 20.6.1
    values: |
      fullnameOverride: {{ .Release.metadata.name }}
      global:
        redis:
          password: {{ .Parameters.redis.password }}
        security:
          allowInsecureImages: true
      master:
        persistence:
          enabled: false
      replica:
        persistence:
          enabled: false
        replicaCount: {{ .Parameters.redis.replicaCount }}
      image:
        {{ $redirection := imageRedirect "docker.io/bitnami/redis" . }}
        registry: {{ $redirection.registry }}
        repository: {{ $redirection.baseRepository }}
        pullPolicy: {{ $redirection.imagePullPolicy | default "IfNotPresent" }}
  - name: commander
    specPatch:
      timeout: 2m
    enabled: "{{ .Parameters.commander.enabled }}"
    source:
      git:
        url: https://github.com/joeferner/redis-commander.git
        path: ././k8s/helm-chart/redis-commander
        branch: master
    values: |
      redis:
        # host is <fullnameOverride>-<moduleName>-master
        host: {{ printf "%s-master" .Release.metadata.name }}
        password: {{ .Parameters.redis.password }}
      image: 
        {{ $redirection := imageRedirect "ghcr.io/joeferner/redis-commander" . }}
        repository: {{ $redirection.repository }}
        pullPolicy: {{ $redirection.imagePullPolicy | default "Always" }}
      ingress:
        enabled: true
        className: {{ .Context.ingress.className }}
        {{- if .Parameters.commander.tls }}
        annotations:
          cert-manager.io/cluster-issuer: {{ required ".Context.certificateIssuer.public must be defined if tls: true" .Context.certificateIssuer.public }}
        {{- end }}
        hosts:
          - host: {{ $uiHost }}.{{.Context.ingress.hostPostfix}}
            paths:
              - "/"
        {{- if .Parameters.commander.tls }}
        tls:
          - secretName: {{ .Release.metadata.name }}-tls
            hosts:
              - {{ $uiHost }}.{{.Context.ingress.hostPostfix}}
        {{- end }}
    dependsOn:
      - redis
roles: |
  - redis
  {{ if .Parameters.commander.enabled }}
  - redis-ui
  {{ end }}
dependencies: |
  {{ if .Parameters.commander.enabled }}
  - ingress
  {{ if .Parameters.commander.tls }}
  - certManager
  {{ end }}
  {{ end }}
