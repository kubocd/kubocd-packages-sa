

apiVersion: v1alpha1
metadata:
  type: Application
  name: podinfo
  version: 0.1.0
spec:
  parametersSchema:
    properties:
      hostname: { type: string, required: false }
      tls: { type: boolean, default: false }
  contextSchema:
    properties:
      ingress:
        required: true
        properties:
          className: { type: string, default: "nginx"}
          hostPostfix: { type: string, required: true }
  templateHeader: |
    {{- $uiHostName := .Parameters.hostname | default (printf "%s-%s" .Release.metadata.name .Release.metadata.namespace) -}}
  usage: |
     Podinfo can be accessed using {{if .Parameters.tls}}https{{else}}http{{end}}://{{ $uiHostName }}.{{ .Context.ingress.hostPostfix }}
  modules:
    - name: main
      source:
        helmRepository:
          url: https://stefanprodan.github.io/podinfo
          chart: podinfo
          version: 6.7.1
      values: |
        ingress:
          enabled: true
          className: {{ .Context.ingress.className  }}
          {{- if .Parameters.tls }}
          annotations:
            cert-manager.io/cluster-issuer: {{ required ".Context.certificateIssuer.public must be defined if tls: true" .Context.certificateIssuer.public }}
          {{- end }}
          hosts:
            - host: {{ $uiHostName }}.{{ .Context.ingress.hostPostfix }}
              paths:
                - path: /
                  pathType: ImplementationSpecific
          {{- if .Parameters.tls }}
          tls:
            - secretName: {{ .Release.metadata.name }}-tls
              hosts:
                - {{ $uiHostName }}.{{ .Context.ingress.hostPostfix }}
          {{- end }}
        {{- $redirection := imageRedirect "ghcr.io/stefanprodan/podinfo:6.7.1" . }}
        image: 
          repository: {{ $redirection.repository }}
          pullPolicy: {{ $redirection.imagePullPolicy | default "IfNotPresent" }}
          tag: {{ $redirection.tag }} 
  dependencies: |
    - ingress
    {{- if .Parameters.tls }}
    - certManager
    {{- end -}}