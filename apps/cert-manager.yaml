
apiVersion: v1alpha1
metadata:
  type: Application
  name: cert-manager
  version: 0.1.0
spec:
  parametersSchema:
    properties:
      trust:
        properties:
          enabled: { type: boolean, default: false }
      issuers:
        properties:
          enabled: { type: boolean, default: true }
          caClusterIssuers:
            items:
              properties:
                name: { type: string, required: true }
                ca_crt: { type: string, required: true }
                ca_key: { type: string, required: true }
          selfSignedClusterIssuers:
            items:
              type: object
              properties:
                name: { type: string, required: true}
  modules:
    - name: main
      source:
        helmRepository:
          url: https://charts.jetstack.io
          chart: cert-manager
          version: v1.17.1 # v1.14.4
      values: |
        installCRDs: true
        enableCertificateOwnerRef: true
        image:
          {{ $redirection := imageRedirect "quay.io/jetstack/cert-manager-controller" . }}
          repository: {{ $redirection.repository }}
    - name: trust
      enabled: "{{ .Parameters.trust.enabled }}"
      source:
        helmRepository:
          url: https://charts.jetstack.io
          chart: trust-manager
          version: v0.16.0 # v0.9.2
      values: |
        app:
          trust:
            namespace: {{ .Release.spec.targetNamespace }}
        secretTargets:
          enabled: false
        image:
          {{ $redirection := imageRedirect "quay.io/jetstack/trust-manager" . }}
          repository: {{ $redirection.repository }}
      dependsOn:
        - main
    - name: issuers
      enabled: "{{ .Parameters.issuers.enabled }}"
      source:
        local:
          path: ../charts/cert-issuers/0.1.0
      values: |
        {{ toYaml .Parameters.issuers }}
        bundle:
          enabled: {{ .Parameters.trust.enabled }}
      dependsOn: |
        - main
        {{ if .Parameters.trust.enabled }}
        - trust
        {{ end }}
  roles:
    - certManager